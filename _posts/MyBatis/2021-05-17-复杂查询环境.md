---
layout:     post
title:      "MyBatis - 复杂查询环境"
subtitle:   " \"MyBatis Knowledge - 06\""
date:       2021.05.17 12:29:00
author:     "Wuy"
header-img: "img/post-bg-2020.jpg"
catalog: true
tags:
    - 学习笔记
    - MyBatis
---

> *"Keep Learning MyBatis"*

# 复杂查询

## 基本环境搭建

- 建表：

    ```mysql
    create table teacher (
        id int(10) not null,
        name varchar(20) default null,
        primary key (id)
    ) engine = innodb default char set =utf8;
    
    insert into teacher (id, name) VALUES (1, 'wuyan');
    
    create table student (
        id int(10) not null,
        name varchar(20) default null,
        tid int(10) default null,
        primary key (id),
        key fktid (tid),
        constraint fktid foreign key (tid) references teacher (id)
    ) engine = innodb default char set = utf8;
    
    insert into student (id, name, tid) VALUES (1, 'wy', 1);
    insert into student (id, name, tid) VALUES (2, 'ws', 1);
    insert into student (id, name, tid) VALUES (3, 'wt', 1);
    insert into student (id, name, tid) VALUES (4, 'wr', 1);
    insert into student (id, name, tid) VALUES (5, 'we', 1);
    ```
    
- 添加`Lombok`依赖：

    ```xml
    <!-- https://mvnrepository.com/artifact/org.projectlombok/lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.20</version>
        <scope>provided</scope>
    </dependency>
    ```

- 新建实体类 `Teacher`和`Student`；

- 新建`Mapper`接口；

- 建立`Mapper.xml`文件；

- 在核心配置文件中注册`Mapper`接口或者文件

## 多对一的处理

### 子查询方式

- 映射文件：

  ```xml
  <mapper namespace="org.example.dao.StudentMapper">
      <select id="getStudent" resultMap="StudentTeacher">
          select * from student
      </select>
  
      <resultMap id="StudentTeacher" type="org.example.pojo.Student">
          <result property="id" column="id"/>
          <result property="name" column="name"/>
  <!--复杂的属性，我们需要单独处理对象，使用对象：association或者集合：collection-->
          <association property="teacher" column="tid" javaType="org.example.pojo.Teacher" select="getTeacher"/>
      </resultMap>
  
      <select id="getTeacher" resultType="org.example.pojo.Teacher">
          select * from teacher where id = #{tid}
      </select>
  <mapper/>
  ```

- 接口文件：

  ```java
  package org.example.dao;
  
  import java.util.List;
  import org.example.pojo.Student;
  import org.example.pojo.Teacher;
  
  public interface StudentMapper {
  
      List<Student> getStudent();
  
      Teacher getTeacher();
  }
  ```

- 测试类：

  ```java
  @Test
  public void demoTest() {
  SqlSession sqlSession = MybatisUtils.getSqlSession();
  
  StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);
  List<Student> studentList = studentMapper.getStudent();
  for (Student student : studentList) {
  System.out.println(student);
  }
  sqlSession.close();
  }
  ```

### 连表查询方式

- 映射文件：

  ```xml
  <select id="getStudent2" resultMap="StudentTeacher2">
          select s.id sid, s.name sname, t.name tname
          from student s, teacher t
          where s.tid = t.id
      </select>
  
      <resultMap id="StudentTeacher2" type="org.example.pojo.Student">
          <result property="id" column="sid"/>
          <result property="name" column="sname"/>
          <association property="teacher" javaType="org.example.pojo.Teacher">
              <result property="name" column="tname"/>
          </association>
      </resultMap>
  ```

- 接口：

  ```java
  List<Student> getStudent2();
  ```

- 测试类：

  ```java
  @Test
      public void demoTest2() {
          SqlSession sqlSession = MybatisUtils.getSqlSession();
  
          StudentMapper studentMapper = sqlSession.getMapper(StudentMapper.class);
          List<Student> studentList = studentMapper.getStudent2();
          for (Student student : studentList) {
              System.out.println(student);
          }
          sqlSession.close();
      }
  ```



## 一对多的处理

### 连表查询方式

- 映射文件：

  ```xml
  <!--namespace 绑定一个对应的Dao/Mapper接口-->
  <mapper namespace="org.example.dao.TeacherMapper">
      <!--按结果嵌套查询-->
      <select id="getTeacher" resultMap="TeacherStudent">
          select s.id sid, s.name sname, t.name tname, t.id tid
          from student s, teacher t
          where s.tid = t.id and t.id = #{tid}
      </select>
  
      <resultMap id="TeacherStudent" type="org.example.pojo.Teacher">
          <result property="id" column="tid"/>
          <result property="name" column="tname"/>
  <!--集合中的泛型类，使用ofType获取-->
          <collection property="studentList" ofType="org.example.pojo.Student">
              <result property="name" column="sname"/>
              <result property="id" column="sid"/>
              <result property="tid" column="tid"/>
          </collection>
      </resultMap>
  ```

- 接口：

  ```java
  Teacher getTeacher(int id);
  ```

### 子查询方式

- 映射文件：

  ```xml
      <select id="getTeacher2" resultMap="TeacherStudent2">
          select * from teacher
      </select>
  
      <resultMap id="TeacherStudent2" type="org.example.pojo.Teacher">
  <!--通过column和子查询进行关联-->
          <collection property="studentList" ofType="Student" select="getStudentByTeacherID" column="id"/>
      </resultMap>
  
      <select id="getStudentByTeacherID" resultType="org.example.pojo.Student">
          select * from student where tid = #{tid}
      </select>
  ```

- 接口：

  ```java
  Teacher getTeacher2(int id);
  
  Student getStudentByTeacherID(int id);
  ```

## 注意点

- 注意是多对一还是一对多，决定使用`association`还是`collection`;
- 问题不好排查的话注意使用日志；
- 保证SQL的可读性，尽量保证通俗易懂。



## 动态SQL

### IF语句

- 建表：

  ```mysql
  create table blog(
      id varchar(100) not null,
      title varchar(20) default null,
      author varchar(20) default null,
      create_time datetime default null,
      views int(10) default null
  ) engine = innodb charset =utf8
  ```

- 接口：

  ```java
  List<Blog> getBlog(Map map);
  ```

- 映射文件：

  ```xml
  <select id="getBlog" parameterType="map" resultType="org.example.pojo.Blog">
      select * from blog where 1=1
      <if test="title != null">
          and title = #{title}
      </if>
      <if test="author != null">
          and author = #{author}
      </if>
  </select>
  ```

- 测试类：

  ```java
      @Test
      public void blogTest2() {
          SqlSession sqlSession = MybatisUtils.getSqlSession();
  
          BlogMapper blogMapper = sqlSession.getMapper(BlogMapper.class);
  
          HashMap<String, String> hashMap = new HashMap<>();
  
          hashMap.put("title", "wuyan");
          System.out.println(blogMapper.getBlog(hashMap));
  
          sqlSession.close();
      }
  ```

- 输出结果只有一条，就是符合title的那一条。

### 常用标签


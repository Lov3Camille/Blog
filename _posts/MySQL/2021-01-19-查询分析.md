---
layout:     post
title:      "MySQL - 查询截取分析"
subtitle:   " \"MySQL Knowledge - 高级部分\""
date:       2021.01.19 12:29:00
author:     "Wuy"
header-img: "img/post-bg-2020.jpg"
catalog: true
tags:
    - 学习笔记
    - 读书
    - MySQL
---

> *"Keep Learning MySQL"*

# 查询截取分析

## 小表驱动大表

原则就是小的数据集驱动大的数据集，比如：

```mysql
select * from A where id in (select id from B);
// 等价于
for select id from B;
for select * from A where A.id = B.id;
```

上述例子，当B表的数据集小于A表的数据集时，用`in` 优于`exists`。

```mysql
select * from A where exists (select 1 from B where B.id = A.id);
// 等价于
for select * from A;
for select * from B where B.id = A.id;
```

当A表的数据集小于B表的数据集时，用`exists`优于`in`。

注意：

- A表与B表的`id`字段需要建立索引;
- `exists`后面的子查询中的`select`清单会被忽略，因此怎么写都没问题。

## `order by`优化

1. `order by`子句，尽量使用`Index`方式排序，避免使用`filesort`方式（也就是`order by`子句用到的字段的顺序索引顺序不一致或者不一样）。
2. 尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀；
3. `order by`的不同的字段的升序或者降序应该保持一致，否则会导致`filesort`。
4. 如果不在索引列上，`filesort`有两种算法：
   - 双路排序：
     - MySQL 4.1 之前是使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和`order by`列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。
   - 单路排序：
     - 从磁盘读取查询需要的所有列，按照`order by`列在`buffer`对他们进行排序，然后扫描排序后的列表进行输出，它的效率更高一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。
   - 后者存在一个可能的风险，就是在`sort_buffer`中，可能取出的数据的总大小超出了`sort_buffer`的容量，导致每次只能取出该容量大小的数据，进行排序（创建临时文件，多路合并）， 排序完再取下一批数据，从而导致多次IO，得不偿失。
5. 优化策略：
   - 增大`sort_buffer_size`参数的设置；
   - 增大`max_length_for_sort_data`参数的设置；
6. MySQL可以为排序和查询使用相同的索引。

## `group by`优化

1. 实质是先排序后进行分组，按照索引建的最佳左前缀；
2. 当无法使用索引列时，增大`max_length_for_sort_data`参数的设置， 并且增大`sort_buffer_size`参数的设置；
3. `where`高于`having`，能写在`where`限定的条件就不要使用`having`。

## 慢查询日志

1. MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间超过`long_query_time`值的SQL，则会被记录到慢查询日志中；

2. `long_query_time`的默认值为10， 意思是指运行十秒以上的语句；

3. 由它来查看哪些`SQL`超出了阈值，进而进行下一步的分析。

4. 默认情况下是没有开启的，因为开启也会影响效率，必要时再开启比较合适。

   ```mysql
   mysql> show variables like "%slow_query_log%";
   +---------------------+-----------------------------------------------------------+
   | Variable_name       | Value                                                     |
   +---------------------+-----------------------------------------------------------+
   | slow_query_log      | OFF                                                       |
   | slow_query_log_file | C:\Program Files\MySQL\MySQL Server 8.0\data\MSI-slow.log |
   +---------------------+-----------------------------------------------------------+
   2 rows in set (0.05 sec)
   
   mysql> set global slow_query_log = 1;
   Query OK, 0 rows affected (0.01 sec)
   
   mysql> show variables like "%slow_query_log%";
   +---------------------+-----------------------------------------------------------+
   | Variable_name       | Value                                                     |
   +---------------------+-----------------------------------------------------------+
   | slow_query_log      | ON                                                        |
   | slow_query_log_file | C:\Program Files\MySQL\MySQL Server 8.0\data\MSI-slow.log |
   +---------------------+-----------------------------------------------------------+
   2 rows in set (0.00 sec)
   ```

   注意上述命令只对当前数据库生效，MySQL重启后会失效，如果要永久生效，需要修改配置文件`my.cnf`（其他系统变量也是如此）

5. 这个是由参数`long_query_time`控制，默认为10秒，大于它才会被记录，而不是等于，另外该参数可以使用命令修改也可以在配置文件修改：

   ```mysql
   mysql> show variables like 'long_query_time%';
   +-----------------+-----------+
   | Variable_name   | Value     |
   +-----------------+-----------+
   | long_query_time | 10.000000 |
   +-----------------+-----------+
   1 row in set (0.00 sec)
   ```

   - `set global long_query_time=3`可以修改阈值，但需要重新连接或新开会话才可以看到修改值。

     ```mysql
     mysql> set global long_query_time = 3;
     Query OK, 0 rows affected (0.00 sec)
     
     mysql> show variables like 'long_query_time%';
     +-----------------+-----------+
     | Variable_name   | Value     |
     +-----------------+-----------+
     | long_query_time | 10.000000 |
     +-----------------+-----------+
     1 row in set (0.00 sec)
     
     mysql> show global variables like 'long_query_time%';
     +-----------------+----------+
     | Variable_name   | Value    |
     +-----------------+----------+
     | long_query_time | 3.000000 |
     +-----------------+----------+
     1 row in set (0.01 sec)
     ```

   - ```bash
     mysql> select sleep(4); # 重新连接会话后
     +----------+
     | sleep(4) |
     +----------+
     |        0 |
     +----------+
     1 row in set (4.00 sec)
     
     C:\Program Files\MySQL\MySQL Server 8.0\data>type MSI-slow.log
     C:\Program Files\MySQL\MySQL Server 8.0\bin\mysqld, Version: 8.0.18 (MySQL Community Server - GPL). started with:
     TCP Port: 3306, Named Pipe: MySQL
     Time                 Id Command    Argument
     # Time: 2021-01-21T04:17:42.985401Z
     # User@Host: root[root] @ localhost [::1]  Id:    81
     # Query_time: 4.001082  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 1
     SET timestamp=1611202658;
     select sleep(4);
     
     mysql> show global status like '%slow_queries%';
     +---------------+-------+
     | Variable_name | Value |
     +---------------+-------+
     | Slow_queries  | 1     |
     +---------------+-------+
     1 row in set (0.01 sec)
     ```

6. 使用日志分析工具`mysqldumpslow`

   



















































